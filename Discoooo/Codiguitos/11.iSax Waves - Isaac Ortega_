s.options.sampleRate = 441000;
ServerOptions.inDevices;
s.options.inDevice = "MIC NAME";
s.meter;
//Code by: Isaac Ortega
//revisa cada bloque porque se te va olvidar que estas haciendo

//-------------------
// Sax Waves
//-------------------
s.boot;
s.waitForBoot {

    // ------------------------
    // REVERB GLOBAL
    // ------------------------
    // 1. BUS Y REVERB (con capacidad de fade individual)
    ~rev = Bus.audio(s, 2);

    SynthDef(\reverb, { |gate = 1, fadeTime = 4|
        var env = EnvGen.kr(Env.asr(0.1, 1, fadeTime), gate, doneAction: 2);
        var sig = In.ar(~rev, 2);
        sig = FreeVerb.ar(sig, 0.7, 0.95, 0.4);
        Out.ar(0, sig * env);
    }).add;

    // Guardamos el synth en una variable para controlarlo
    ~reverbSynth = Synth(\reverb, addAction: \addToTail);


    // ------------------------
    // KICK profundo
    // ------------------------
    SynthDef(\kick, { |amp=0.8|
        var env = Env.perc(0.001, 0.5, amp).ar(doneAction: 2);
        var osc = SinOsc.ar(50, 0, env);
        osc = LPF.ar(osc, 200);
        Out.ar(~rev, osc);
    }).add;

    // ------------------------
    // SNARE grande
    // ------------------------
    SynthDef(\snare, { |amp=0.4|
        var env = Env.perc(0.005, 0.4, amp).ar(doneAction: 2);
        var noise = WhiteNoise.ar * env;
        noise = BPF.ar(noise, 2500, 0.3);
        Out.ar(~rev, noise);
    }).add;

    // ------------------------
    // SWELL — platillos
    // ------------------------
    SynthDef(\swellCym, { |amp=0.2, time=6|
        var env = Env.linen(time*0.6, time*0.3, time*0.1, amp).ar(doneAction: 2);
        var noise = PinkNoise.ar * env;
        noise = HPF.ar(noise, 3000);
        Out.ar(~rev, noise);
    }).add;

    // ------------------------
    // SWELL ambient
    // ------------------------
    SynthDef(\wSwell, { |freq=200, amp=0.3, time=5|
        var env = Env.linen(time*0.4, time*0.4, time*0.2, amp).ar(doneAction: 2);
        var sig = Saw.ar(freq ! 2, 0.3);
        sig = LPF.ar(sig, 1500);
        sig = sig * env;
        Out.ar(~rev, sig);
    }).add;

    // ------------------------
    //  PLUCK Arpegio)
    // ------------------------
    // Un sonido tipo "punteo" con filtro resonante
    SynthDef(\pluck, { |freq=440, amp=0.2, pan=0, cut=1000|
        var env = Env.perc(0.01, 0.4).ar(doneAction: 2);
        // "digital/retro"
        var sig = Pulse.ar(freq, 0.5) * env;
        //  efecto "plucky"
        sig = RLPF.ar(sig, cut * env + 100, 0.3);
        sig = Pan2.ar(sig, pan, amp);
        Out.ar(~rev, sig);
    }).add;


    //-----------------------------------------
    // PATRONES
    //-----------------------------------------

    Pdef(\kick,
        Pbind(
            \instrument, \kick,
            \dur, 2,
            \amp, 3
        )
    ).play;

    Pdef(\snare,
        Pbind(
            \instrument, \snare,
            \dur, Pseq([1, 3], inf),
            \amp, 0.5
        )
    ).play;

    Pdef(\swellCym,
        Pbind(
            \instrument, \swellCym,
            \dur, 16,
            \time, 8
        )
    ).play;

    Pdef(\ambientSwells,
        Pbind(
            \instrument, \wSwell,
            \freq, Pwhite(150, 400),
            \dur, Prand([8, 12, 16], inf),
            \time, Prand([4, 6, 8], inf),
            \amp, 0.50
        )
    ).play;

	// Arpegio Algorítmico
  ( Pdef(\arpeggiator,
        Pbind(
            \instrument, \pluck,
            \out, ~rev,    // Conexión con reverb

            // Escala y notas
			\scale, Scale.minor,
            \root, 0,
            \degree, Pbrown(-7, 7, 2, inf), // Melodía andante
            \octave, Prand([4, 5, 6, 7, 8], inf),

            // Ritmo y carácter
            \dur, Prand([0.25, 0.25, 1 ], inf), // Lento
            \cut, Pwhite(150, 4000),             // Filtro moviéndose
            \amp, 0.50,
            \pan, Pwhite(-0.5, 0.5)
        )
	).play)

///-------------------
///Reverb para sax
///-------------------
({
    var sig;
    sig = SoundIn.ar(0);
    sig = FreeVerb.ar(sig, mix: 0.4, room: 0.7);
    sig.dup;
	}.play;)

//Interfaz del Volumen Maestgro
s.volume.gui;

};